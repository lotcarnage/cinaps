{% extends 'base.html' %}
{% block head %}
<title>Projects</title>
<link rel="stylesheet" href="/static/css/basic.css" />
<link rel="stylesheet" href="/static/css/projects.css" />
<style>
    div.grapharea {
        position: relative;
    }

    canvas.network {
        position: absolute;
        background-color: #444;
    }

    div.dfd_deliverable {
        border-radius: 4px;
        background-color: #fff;
        filter: drop-shadow(2px 2px 2px rgba(0.2, 0.2, 0.2, 0.2));
        vertical-align: middle;
        position: absolute;
        text-align: center;
        display: flex;
        align-items: center;
        margin: 0px;
    }

    div.dfd_task {
        border-radius: 4px;
        background-color: #fff;
        filter: drop-shadow(2px 2px 2px rgba(0.2, 0.2, 0.2, 0.2));
        vertical-align: middle;
        position: absolute;
        text-align: center;
        display: flex;
        align-items: center;
        margin: 0px;
    }

    div.focused {
        background-color: aquamarine;
    }
</style>
{% endblock %}

{% block body %}
<p><a href="/home">Home</a></p>


{% include 'taskeditor.html' %}

<div id="dfd_meta" data-num-deliverables="{{dfd_deliverables | length}}" data-num-tasks="{{dfd_tasks | length}}">
</div>
<div id="task_to_deliverable_edges">
    {% for edge in task_to_deliverable_edges %}
    <span data-edge='{"task_id":{{edge.task_id}}, "deliverable_id":{{edge.deliverable_id}}}'></span>
    {% endfor %}
</div>
<div id="deliverable_to_task_edges">
    {% for edge in deliverable_to_task_edges %}
    <span data-edge='{"deliverable_id":{{edge.deliverable_id}}, "task_id":{{edge.task_id}}}'></span>
    {% endfor %}
</div>
<div class="grapharea">
    <canvas id="network" class="network" width="800px" height="800px"></canvas>
    {% for deliverable in dfd_deliverables %}
    <div class="dfd_deliverable" id="deliverable_{{deliverable.id}}" tabindex=0><span>成果物：{{deliverable.label}}</span></div>
    {% endfor %}
    {% for task in dfd_tasks %}
    <div class="dfd_task" id="task_{{task.id}}" tabindex=0><span>タスク：{{task.subject}}</span></div>
    {% endfor %}
</div>

<script src="https://frogcat.github.io/canvas-arrow/canvas-arrow.js"></script>
<script>
    function initialize() {
        const GRID_SIZE = 16;
        const numDeliverables = parseInt(document.getElementById("dfd_meta").dataset.numDeliverables);
        const numTasks = parseInt(document.getElementById("dfd_meta").dataset.numTasks);
        function SetPosition(element, w, h, left, top) {
            element.style.left = (GRID_SIZE * left + 1).toString() + 'px';
            element.style.top = (GRID_SIZE * top + 1).toString() + 'px';
            element.style.width = (GRID_SIZE * w - 2).toString() + 'px';
            element.style.height = (GRID_SIZE * h - 2).toString() + 'px';
        }
        for (let i = 0; i < numDeliverables; i++) {
            const element = document.getElementById(`deliverable_${i + 1}`);
            element.addEventListener('focus', e => { console.log(e); e.target.classList.add('focused'); });
            element.addEventListener('blur', e => { console.log(e); e.target.classList.remove('focused'); });
            SetPosition(element, 8, 2, 0, i * 2);
        }
        for (let i = 0; i < numTasks; i++) {
            const element = document.getElementById(`task_${i + 1}`);
            element.addEventListener('focus', e => { console.log(e); e.target.classList.add('focused'); });
            element.addEventListener('blur', e => { console.log(e); e.target.classList.remove('focused'); });
            SetPosition(element, 8, 2, 12, i * 2);
        }

        const canvas = document.getElementById("network");
        const context = canvas.getContext("2d");
        context.beginPath();
        context.strokeStyle = "#f00";
        context.fillStyle = "#f00";
        context.lineWidth = 0;
        context.arrow(GRID_SIZE * 8, GRID_SIZE * 1, GRID_SIZE * 12, GRID_SIZE * 1, [0, 6, -10, 6, -10, 10]);
        context.fill();
        context.stroke();
    }
    initialize();
</script>
{% endblock %}